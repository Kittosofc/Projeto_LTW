<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Stock</title>
  <link rel="stylesheet" href="CSS/main.css" />
<link rel="stylesheet" href="CSS/home_sidebarstock.css" />
  <link rel="stylesheet" href="CSS/home_gerirstock.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body data-theme="light">
  <aside class="sidebar">

    <nav>
    <ul class="main-menu">
    <li>
        <a href="#">
            <svg class ="menu-icon" width="16" height="18" viewBox="0 0 16 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 18C1.45 18 0.979333 17.8043 0.588 17.413C0.196 17.021 0 16.55 0 16V7C0 6.68333 0.0709998 6.38333 0.213 6.1C0.354333 5.81667 0.55 5.58333 0.8 5.4L6.8 0.9C6.98333 0.766667 7.175 0.666667 7.375 0.6C7.575 0.533333 7.78333 0.5 8 0.5C8.21667 0.5 8.425 0.533333 8.625 0.6C8.825 0.666667 9.01667 0.766667 9.2 0.9L15.2 5.4C15.45 5.58333 15.646 5.81667 15.788 6.1C15.9293 6.38333 16 6.68333 16 7V16C16 16.55 15.8043 17.021 15.413 17.413C15.021 17.8043 14.55 18 14 18H10V11H6V18H2Z"/>
            </svg>
            <span>Geral</span>
        </a>
    </li>
    <li>  
        <a href="#" class="active">
            <img src="IMG/stock.png" alt="Stock Icon" style="filter: brightness(0) invert(1); width: 22px; height: 22px;">
            <span style="color: #fff;">Estoque</span>
        </a>
    </li>

    <li>
        <a href="#" id="logout-btn">  
            <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 18C1.45 18 0.979 17.8043 0.587 17.413C0.195667 17.021 0 16.55 0 16V2C0 1.45 0.195667 0.979 0.587 0.587C0.979 0.195667 1.45 0 2 0H9V2H2V16H9V18H2ZM13 14L11.625 12.55L14.175 10H6V8H14.175L11.625 5.45L13 4L18 9L13 14Z"/>
            </svg>          
            <span>Sair</span>
        </a>
    </li>
  
  </ul>
      <div class="sidebar-footer">
        <button id="theme-toggle" aria-label="Alternar tema">ðŸŒ™</button>
      </div>
    </nav>
  </aside>


  <main class="main">
    <header class="header">
      <div class="location-wrapper">
        <img src="IMG/location-icon.png" alt="LocalizaÃ§Ã£o" class="icon-location">
        <select>
          <option selected>Medianeira, PR</option>
          <option>SÃ£o Paulo, SP</option>
          <option>Rio de Janeiro, RJ</option>
          <option>Outros...</option>
        </select>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Pesquisar...">
        <img src="IMG/search-icon.png" alt="Pesquisar" class="icon-search">
      </div>
    </header>

    

 <div class="stock-container">
      <div class="stock-table">
        <div class="table-header">
          <div class="checkbox-cell">
            <input type="checkbox" id="select-all">
          </div>
<span>Produto</span>
<span>Stock</span>
<span>PreÃ§o</span>
<span>Pontos</span>
<span>AÃ§Ãµes</span>


        </div>
        <div id="product-list"></div>
      </div>
    </div>
    
    <div id="modal-editar" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 9999;">
  <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 100%;">
    <h2 style="margin-bottom: 24px; font-weight: 600; font-size: 24px; color: #2c3e50;">Editar Produto</h2>
  
  <div style="display: flex; flex-direction: column; gap: 16px;">
    <div>
      <label for="edit-nome" style="font-weight: 500;">Nome do Produto</label>
      <input type="text" id="edit-nome" class="form-control" placeholder="Ex: Gasolina Premium"
             style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;" />
    </div>

    <div style="display: flex; gap: 10px;">
      <div style="flex: 1;">
        <label for="edit-stock" style="font-weight: 500;">Stock</label>
        <input type="number" id="edit-stock" class="form-control" placeholder="Ex: 100"
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;" />
      </div>
      <div style="flex: 1;">
        <label for="edit-preco" style="font-weight: 500;">PreÃ§o (â‚¬)</label>
        <input type="number" step="0.01" id="edit-preco" class="form-control" placeholder="Ex: 5.50"
               style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;" />
      </div>
    </div>

    <div>
      <label for="edit-pontos" style="font-weight: 500;">Pontos por Unidade</label>
      <input type="number" id="edit-pontos" class="form-control" placeholder="Ex: 10"
             style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;" />
    </div>

    <div>
  <label for="edit-imagem" style="font-weight: 500;">Caminho da Imagem</label>
  <input type="text" id="edit-imagem" class="form-control" placeholder="Ex: Cola.png"
         style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;" />
</div>

    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="fecharModal()" style="padding: 8px 16px; background: #ccc; border: none; border-radius: 5px;">Cancelar</button>
      <button onclick="confirmarEdicao()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px;">Salvar</button>
    </div>
  </div>
</div>
</main>
<script>
  
  async function carregarProdutos() {
    const container = document.getElementById('product-list');
    container.innerHTML = '';

    const res = await fetch('/api/productos');
    const produtos = await res.json();

    produtos.forEach(produto => {
      const row = document.createElement('div');
      row.className = 'product-row';
      row.dataset.id = produto.id_producto;

row.innerHTML = `
  <div class="checkbox-cell"><input type="checkbox" class="product-checkbox"></div>
  <div class="product-info">
    <img src="IMG/${produto.imagen || 'sim_imagen.jpg'}" alt="${produto.nombre_producto}" class="product-image">
    <span class="product-name">${produto.nombre_producto}</span>
  </div>
  <div class="quantity-controls">
    <span class="quantity-display">${produto.stock_actual}</span>  </div>
  <div class="category">â‚¬ ${(Number(produto.precio) || 0).toFixed(2)}</div>   
  <div class="category">${Number(produto.puntos_por_unidad)} pts</div>


  <div class="actions">
    <button class="action-btn edit-btn" onclick="editProduct(this)">

      <img src="IMG/edit.png" alt="Editar" class="action-icon">
    </button>
    <button class="action-btn delete-btn" onclick="fecharModal()"">
      <img src="IMG/delete.png" alt="Apagar" class="action-icon">
    </button>
  </div>
`;


      container.appendChild(row);
    });
  }

  function changeQuantity(button, change) {
    const row = button.closest('.product-row');
    const quantityDisplay = row.querySelector('.quantity-display');
    const id = row.dataset.id;
    let stock = parseInt(quantityDisplay.textContent);

    stock = Math.max(0, stock + change);
    quantityDisplay.textContent = stock;

    fetch(`/api/productos/${id}/stock`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ stock })
    }).catch(err => console.error('Erro ao atualizar stock', err));
  }



function editProduct(button) {
  const row = button.closest('.product-row');
  if (!row) {
    alert("Erro ao identificar o produto.");f
    return;
  }

  idSelecionado = row.dataset.id;

  document.getElementById('edit-nome').value = row.querySelector('.product-name').textContent;
  document.getElementById('edit-stock').value = row.querySelector('.quantity-display').textContent;
  document.getElementById('edit-preco').value = parseFloat(row.querySelectorAll('.category')[0].textContent.replace('â‚¬', '').trim());
  document.getElementById('edit-pontos').value = parseInt(row.querySelectorAll('.category')[1].textContent);

  document.getElementById('modal-editar').style.display = 'flex';
  const imagem = row.querySelector('.product-image').getAttribute('src').split('/').pop();
const inputImagem = document.getElementById('edit-imagem'); 
inputImagem.value = ''; // valor vazio para permitir nova escrita
inputImagem.placeholder = imagem; // mostra imagem atual como placeholder

}
function atualizarProduto(nome, stock, preco, pontos, imagem) {
  fetch(`/api/productos/${idSelecionado}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      nombre_producto: nome,
      stock_actual: stock,
      precio: preco,
      pontos_por_unidad: pontos,
      imagen: imagem
    })
  }).then(() => {
    fecharModal();
    location.reload();
  });
}


document.getElementById('logout-btn').addEventListener('click', async function (e) {
  e.preventDefault();

  try {
    const res = await fetch('/admin/logout', { method: 'POST' });

    if (res.ok) {
      window.location.href = '/login_adm.html'; // ou outra pÃ¡gina de login
    } else {
      alert('Erro ao terminar sessÃ£o.');
    }
  } catch (err) {
    console.error('Erro no logout:', err);
    alert('Erro na requisiÃ§Ã£o de logout.');
  }
});


let idSelecionado = null;



  function deleteProduct(button) {
    const row = button.closest('.product-row');
    const id = row.dataset.id;
    const nome = row.querySelector('.product-name').textContent;

    if (confirm(`Apagar "${nome}"?`)) {
      fetch(`/api/productos/${id}`, {
        method: 'DELETE'
      }).then(() => {
        row.remove();
      });
    }
  }

function confirmarEdicao() {
  const nome = document.getElementById('edit-nome').value;
  const stock = document.getElementById('edit-stock').value;
  const preco = document.getElementById('edit-preco').value;
  const pontos = document.getElementById('edit-pontos').value;
  const imagem = document.getElementById('edit-imagem').value;

  atualizarProduto(nome, stock, preco, pontos, imagem);
}


function fecharModal() {
  document.getElementById('modal-editar').style.display = 'none';
}

  window.addEventListener('DOMContentLoaded', carregarProdutos);
</script>

</body>
</html>
